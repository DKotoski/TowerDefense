<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Cinderella</title>
    <script src="Scripts/pixi.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
            overflow: hidden;
        }
    </style>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no">
</head>
<body>
    <div id="daGame">    </div>
    <button id="addTower">add tower</button>
    <style>
        body{
            text-align: center;
            background: blanchedalmond;
        }
        #daGame{
            margin: auto;
            width:920px;
            background:bisque;
        }
    </style>
    <script>
        // setting up renderer
        var renderer = new PIXI.WebGLRenderer(920, 640);
        $("#daGame").append(renderer.view);
        //setting stage
        var stage = new PIXI.Stage(0x97c56e, true);

        //setting sprites
        //towers

        //tower constructor
        function Tower(sprite, x, y, shootSpeed) {
            this.shootSpeed = shootSpeed;
            this.range = 150;
            this.sprite = sprite;
            this.x = x;
            this.y = y;
            this.sprite.position.x = x - 32;
            this.sprite.position.y = y - 32;
            this.sprite.pivot.x = 32;
            this.sprite.pivot.y = 32;
            this.target=null;
            this.targetIndex=-1;
            var tower = this;
            this.toSpriteCoordinates = function (x, y) {
                tower.sprite.position.x = x - 32;
                tower.sprite.position.y = y - 32;
            };
            this.fromSpriteCoordinates = function (x, y) {
                tower.x = x + 32;
                tower.y = y + 32;
            };
            this.position = function (x, y) {
                tower.sprite.position.x = x;
                tower.sprite.position.y = y;
                this.fromSpriteCoordinates(x, y);
            };
            this.rotate = function(angle){
                tower.sprite.rotation = angle;
            };
            this.getTarget= function(index){
                if(index==-1) return;
                var distance = Math.sqrt((tower.x - enemies[index].x) * (tower.x - enemies[index].x) + (tower.y - enemies[index].y) * (tower.y - enemies[index].y));
                if(distance>tower.range) 
                {
                    tower.target=null;
                    tower.targetIndex=-1;
                    tower.getTarget(index-1);
                }
                if (distance < tower.range) {
                    tower.targetIndex = index;
                    tower.target=enemies[index];
                    if(!stage.contains(tower.target.sprite)){
                        tower.target=null;
                        tower.targetIndex = -1;
                        //console.log("vleze");
                        return;
                    }            
                    
                    var angle = Math.atan((tower.target.y-tower.y)/(tower.target.x - tower.x));
                    if (tower.target.x < tower.x) angle += 3.14;
                    tower.rotate(angle);                    
                }
            };
            this.shootTarget = function(){
                if(tower.target==null) return;
                tower.getTarget(enemies.length-1);
                if(tower.target==null) return;
                var toRemove = tower.target.sprite;
                //console.log(tower.shootSpeed);
                enemies.splice(tower.targetIndex,1);
                    if(stage.contains(toRemove)){
                        stage.removeChild(toRemove);
                    }
                    //console.log(tower.targetIndex);
                    tower.target=null;
                    tower.targetIndex = -1;
                    return;                    
            }
            
        }
        //end tower constructor

        // enemy constuctor
        function Enemy(x, y) {
            this.sprite = new PIXI.Sprite(PIXI.Texture.fromImage("Assets/enemy.png"));
            this.x = x;
            this.y = y;
            this.sprite.position.x = x - 32;
            this.sprite.position.y = y - 32;
            this.sprite.pivot.x = 32;
            this.sprite.pivot.y = 32;
            this.speed = 2;
            var enemy = this;
            this.toSpriteCoordinates = function (x, y) {
                enemy.sprite.position.x = x - 32;
                enemy.sprite.position.y = y - 32;
            };
            this.fromSpriteCoordinates = function (x, y) {
                enemy.x = x + 32;
                enemy.y = y + 32;
            };
            this.position = function (x, y) {
                enemy.sprite.position.x = x;
                enemy.sprite.position.y = y;
                this.fromSpriteCoordinates(x, y);
            };
            this.move = function () {
                if(enemy.sprite.position.y>=640){
                    health--;
                    enemies.pop();
                    if(stage.contains(enemy.sprite)){
                        stage.removeChild(enemy.sprite);
                    }
                    return;
                }
                if(enemy.sprite.position.y<64)
                {
                    enemy.fromSpriteCoordinates(enemy.sprite.position.x, enemy.sprite.position.y);
                    enemy.toSpriteCoordinates(enemy.x, enemy.y + enemy.speed);   
                }else{
                enemy.fromSpriteCoordinates(enemy.sprite.position.x, enemy.sprite.position.y);
                var dx = pathMatrix[Math.floor(enemy.y / 64) - 1][Math.floor(enemy.x / 64) - 1][0] / enemy.speed;
                var dy = pathMatrix[Math.floor(enemy.y / 64) - 1][Math.floor(enemy.x / 64) - 1][1] / enemy.speed;               
                enemy.toSpriteCoordinates(enemy.x + dx, enemy.y + dy);
                }
            };
        }
        //end enemy constructor

        // UI ELEMENT CONSTRUCTOR
        function UIElement(sprite, x, y) {
            var sprite = new PIXI.Sprite(PIXI.Texture.fromImage(sprite));
            sprite.setInteractive(true);
            this.Sprite = sprite;
            this.x = x;
            this.y = y;
            this.sprite.position.x = x - 32;
            this.sprite.position.y = y - 32;
            this.sprite.pivot.x = 32;
            this.sprite.pivot.y = 32;
            this.spriteLocation = sprite;
            var element = this;
            this.Sprite.mousedown = function(data)
            {
                this.data = data;
                this.alpha = 0.5;
                this.dragging = true;
            };
            this.Sprite.mouseup = bunny.mouseupoutside = bunny.touchend = bunny.touchendoutside = function(data)
            {
                this.alpha = 1
                this.dragging = false;
                // set the interaction data to null
                this.data = null;
            };
        }
        //
        var towers = [new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t1.png")), 64 * 4, 64 * 3, 85), new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t2.png")), 64 * 7, 64 * 5, 245), new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t3.png")), 64 * 6, 64 * 3, 300), new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t3.png")), 64 * 6, 64 * 7, 300)];
        
        var bunny = new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t1.png"));
        bunny.position.x = 64 * 12;
        bunny.position.y = 64 * 2;
        bunny.interactive = true;
        
        bunny.mousedown = bunny.touchstart = function (data) {
            this.data = data;
            this.alpha = 0.5;
            this.dragging = true;
        };

        bunny.mouseup = bunny.mouseupoutside = bunny.touchend = bunny.touchendoutside = function (data) {
            this.alpha = 1
            this.dragging = false;
            // set the interaction data to null
            
            var newPosition = this.data.getLocalPosition(this.parent);
            //proverka dali e na treva po pozadinskata matrica!
            this.position.x = Math.floor(newPosition.x / 64) * 64;;
            this.position.y = Math.floor(newPosition.y / 64) * 64;
           // var tmpTower = new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t1.png")), newPosition.x%64 * 64, newPosition.y%64 * 64, 85);
           // towers.push(tmpTower);
            //stage.addChild(tmpTower);
            this.data = null;
        };

        bunny.mousemove = bunny.touchmove = function (data) {
            if (this.dragging) {
                // need to get parent coords..
                var newPosition = this.data.getLocalPosition(this.parent);
                this.position.x = newPosition.x;
                this.position.y = newPosition.y;
            }
        }

        var stageMatrix = [
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
            [1, 1, 1, 1, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 0, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 0, 0, 0, 0, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 0, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 1, 1],
            [1, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 1]];

        var pathMatrix = [
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+65, 0], [0, +10], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [0, +10], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [0, +10], [0, +10], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [0, +10], [-64, 0], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [0, +10], [-64, 0], [-64, 0]],
            [[0, +10], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-64, 0], [-64, 0]],
            [[0, +10], [0, +10], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0]],
            [[+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [0, +10], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [0, +10], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [0, +10], [-64, 0]]];

        for (var i = 0; i < 10; i++) {
            for (var j = 0; j < 10; j++) {
                var texture;
                if (stageMatrix[i][j] === 1) {
                    texture = new PIXI.Sprite(PIXI.Texture.fromImage("Assets/grass.png"));
                } else {
                    texture = new PIXI.Sprite(PIXI.Texture.fromImage("Assets/pavement.png"));
                }
                texture.position.x = j * 64;
                texture.position.y = i * 64;
                stage.addChild(texture);
            }
        }
        for (var i = 0; i < towers.length; i++) {
            stage.addChild(towers[i].sprite);
        }

        stage.addChild(bunny);
        
        
        var enemies = new Array();
        
        var enemiesN = 300;
        for(var i = 0 ; i < enemiesN ;i++){
            var enemy = new Enemy(64*9,(64-(20*enemiesN))+(i*20)); 
            enemies.push(enemy);
            stage.addChild(enemy.sprite);
        }
        
            
        var health = 100;
        
        
        var text = new PIXI.Text(health, {font:"50px Arial", fill:"red"});
        stage.addChild(text);
        var timer = 0;
        //the animation function
        requestAnimationFrame(animate);
        function animate() {
            timer++;
            timer=timer%1000;
            text.setText(health);
            for (var i = 0; i < towers.length; i++) {
                towers[i].getTarget(enemies.length-1);
            }
             
                for (var i = 0; i < towers.length; i++) {
                    if(timer%towers[i].shootSpeed==0&&towers[i].target!=null) towers[i].shootTarget();
                }
            
            for(var i=0;i<enemies.length;i++){
                enemies[i].move();                
            }
            renderer.render(stage);
            requestAnimationFrame(animate);
        }
        //end animation
        var towerPlacement = 0 ;
        $("#addTower").on("click",function(){
            var t = new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t1.png")), 64 * 3, 64 * 3+64*towerPlacement,100);
            towers.push(t);
            stage.addChild(t.sprite);
            towerPlacement++;
        });
    </script>
</body>
</html>
