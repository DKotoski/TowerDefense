<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Cinderella</title>
    <script src="Scripts/pixi.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
            overflow: hidden;
        }
    </style>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=yes">
</head>
<body>
    <div id="daGame">    </div>
    <style>
        body{
            text-align: center;
            background: blanchedalmond;
        }
        #daGame{
            margin: auto;
            width:920px;
            background:bisque;
        }
    </style>
    <script>
        // setting up renderer
        var renderer = new PIXI.CanvasRenderer(920, 640);
        $("#daGame").append(renderer.view);
        //setting stage
        var stage = new PIXI.Stage(0x97c56e, true);

        //setting sprites
        //towers

        //tower constructor
        function Tower(sprite, x, y, shootSpeed) {
            this.shootSpeed = shootSpeed;
            this.range = 150;
            this.sprite = sprite;
            this.x = x;
            this.y = y;
            this.sprite.position.x = x - 32;
            this.sprite.position.y = y - 32;
            this.sprite.pivot.x = 32;
            this.sprite.pivot.y = 32;
            this.target=null;
            this.targetIndex=-1;
            var tower = this;
            this.toSpriteCoordinates = function (x, y) {
                tower.sprite.position.x = x - 32;
                tower.sprite.position.y = y - 32;
            };
            this.fromSpriteCoordinates = function (x, y) {
                tower.x = x + 32;
                tower.y = y + 32;
            };
            this.position = function (x, y) {
                tower.sprite.position.x = x;
                tower.sprite.position.y = y;
                this.fromSpriteCoordinates(x, y);
            };
            this.rotate = function(angle){
                tower.sprite.rotation = angle;
            };
            this.getTarget= function(index){
                if(index==-1) return;
                var distance = Math.sqrt((tower.x - enemies[index].x) * (tower.x - enemies[index].x) + (tower.y - enemies[index].y) * (tower.y - enemies[index].y));
                if(distance>tower.range) 
                {
                    tower.target=null;
                    tower.targetIndex=-1;
                    tower.getTarget(index-1);
                }
                if (distance < tower.range) {
                    tower.targetIndex = index;
                    tower.target=enemies[index];
                    if(!stage.contains(tower.target.sprite)){
                        tower.target=null;
                        tower.targetIndex = -1;
                        //console.log("vleze");
                        return;
                    }            
                    
                    var angle = Math.atan((tower.target.y-tower.y)/(tower.target.x - tower.x));
                    if (tower.target.x < tower.x) angle += 3.14;
                    tower.rotate(angle);                    
                }
            };
            this.shootTarget = function(){
                if(tower.target==null) return;
                tower.getTarget(enemies.length-1);
                if(tower.target==null) return;
                var toRemove = tower.target.sprite;
                //console.log(tower.shootSpeed);
                enemies.splice(tower.targetIndex,1);
                    if(stage.contains(toRemove)){
                        stage.removeChild(toRemove);
                    }
                    //console.log(tower.targetIndex);
                    tower.target=null;
                    tower.targetIndex = -1;
                    money += 10;
                    return;                    
            }
            
        }
        //end tower constructor

        // enemy constuctor
        function Enemy(x, y) {
            this.sprite = new PIXI.Sprite(PIXI.Texture.fromImage("Assets/enemy.png"));
            this.x = x;
            this.y = y;
            this.sprite.position.x = x - 32;
            this.sprite.position.y = y - 32;
            this.sprite.pivot.x = 32;
            this.sprite.pivot.y = 32;
            this.speed = 10;
            var enemy = this;
            this.toSpriteCoordinates = function (x, y) {
                enemy.sprite.position.x = x - 32;
                enemy.sprite.position.y = y - 32;
            };
            this.fromSpriteCoordinates = function (x, y) {
                enemy.x = x + 32;
                enemy.y = y + 32;
            };
            this.position = function (x, y) {
                enemy.sprite.position.x = x;
                enemy.sprite.position.y = y;
                this.fromSpriteCoordinates(x, y);
            };
            this.move = function () {
                if(enemy.sprite.position.y>=640){
                    health--;
                    enemies.pop();
                    if(stage.contains(enemy.sprite)){
                        stage.removeChild(enemy.sprite);
                    }
                    return;
                }
                if(enemy.sprite.position.y<64)
                {
                    enemy.fromSpriteCoordinates(enemy.sprite.position.x, enemy.sprite.position.y);
                    enemy.toSpriteCoordinates(enemy.x, enemy.y + 10/enemy.speed);   
                }else{
                enemy.fromSpriteCoordinates(enemy.sprite.position.x, enemy.sprite.position.y);
                var dx = pathMatrix[Math.floor(enemy.y / 64) - 1][Math.floor(enemy.x / 64) - 1][0] / enemy.speed;
                var dy = pathMatrix[Math.floor(enemy.y / 64) - 1][Math.floor(enemy.x / 64) - 1][1] / enemy.speed;               
                enemy.toSpriteCoordinates(enemy.x + dx, enemy.y + dy);
                }
            };
        }
        //end enemy constructor

        // UI ELEMENT CONSTRUCTOR
        function UIElement(sprite, x, y, price) {
            this.sprite = new PIXI.Sprite(PIXI.Texture.fromImage(sprite));            
            this.x = x;
            this.y = y;
            this.sprite.position.x = x - 32;
            this.sprite.position.y = y - 32;
            this.sprite.pivot.x = 32;
            this.sprite.pivot.y = 32;
            this.spriteLocation = sprite;
            this.price = price;
            var element = this;
            this.dim = function () {
                element.sprite.alpha = 0.5;
                element.sprite.interactive = false;
            }
            this.dimOut = function () {
                element.sprite.alpha = 1;
                element.sprite.interactive = true;
            }
           
            element.sprite.mousedown = element.sprite.touchstart = function (data) {
                console.log("mousedown");
                this.data = data;
                this.alpha = 0.5;
                this.dragging = true;
            };
            element.sprite.mouseup = element.sprite.mouseupoutside = element.sprite.touchend = element.sprite.touchendoutside = function (data) {
                this.alpha = 1
                this.dragging = false;            
                var newPosition = this.data.getLocalPosition(this.parent);
                if (money >= element.price) {
                    if (stageMatrix[Math.floor(newPosition.y / 64)][Math.floor(newPosition.x / 64)] === 1) {
                        var tmpX = (Math.floor(newPosition.x / 64) + 1) * 64;
                        var tmpY = (Math.floor(newPosition.y / 64) + 1) * 64;
                        var t = new Tower(new PIXI.Sprite(PIXI.Texture.fromImage(element.spriteLocation)), tmpX, tmpY, 100);
                        towers.push(t);
                        stage.addChild(t.sprite);
                        money -= element.price;
                        this.position.x = x - 32;
                        this.position.y = y - 32;
                    } else {
                        this.position.x = x - 32;
                        this.position.y = y - 32;
                    }
                } else {
                    this.position.x = x - 32;
                    this.position.y = y - 32;
                }
                this.data = null;
        };
        element.sprite.mousemove = element.sprite.touchmove = function (data) {
            if (this.dragging) {
                var newPosition = this.data.getLocalPosition(this.parent);
                this.position.x = newPosition.x;
                this.position.y = newPosition.y;
            }
        }
        
        }
        //
        //var towers = [new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t1.png")), 64 * 4, 64 * 3, 85), new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t2.png")), 64 * 7, 64 * 5, 245), new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t3.png")), 64 * 6, 64 * 3, 300), new Tower(new PIXI.Sprite(PIXI.Texture.fromImage("Assets/t3.png")), 64 * 6, 64 * 7, 300)];
        var towers = new Array();
        var uiElements = [new UIElement("Assets/t1.png",64*12,64*2,100), new UIElement("Assets/t2.png",64*12,64*4,200), new UIElement("Assets/t3.png",64*12,64*6,300)];
        
        var stageMatrix = [
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
            [1, 1, 1, 1, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 0, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 0, 0, 0, 0, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 0, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 1, 1],
            [1, 0, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 0, 1]];

        var pathMatrix = [
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+65, 0], [0, +10], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [0, +10], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [0, +10], [0, +10], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [0, +10], [-64, 0], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [0, +10], [-64, 0], [-64, 0]],
            [[0, +10], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-10, 0], [-64, 0], [-64, 0]],
            [[0, +10], [0, +10], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0], [-64, 0]],
            [[+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [+10, 0], [0, +10], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [0, +10], [-64, 0]],
            [[+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [+64, 0], [0, +10], [-64, 0]]];

        for (var i = 0; i < 10; i++) {
            for (var j = 0; j < 10; j++) {
                var texture;
                if (stageMatrix[i][j] === 1) {
                    texture = new PIXI.Sprite(PIXI.Texture.fromImage("Assets/grass.png"));
                } else {
                    texture = new PIXI.Sprite(PIXI.Texture.fromImage("Assets/pavement.png"));
                }
                texture.position.x = j * 64;
                texture.position.y = i * 64;
                stage.addChild(texture);
            }
        }
        for (var i = 0; i < towers.length; i++) {
            stage.addChild(towers[i].sprite);
        }

        for(var i =0;i<uiElements.length;i++){
            stage.addChild(uiElements[i].sprite);
        }
        
        
        
        var enemies = new Array();
        
        var enemiesN = 50;
        for(var i = 0 ; i < enemiesN ;i++){
            var enemy = new Enemy(64*9,(64-(20*enemiesN))+(i*20)); 
            enemies.push(enemy);
            stage.addChild(enemy.sprite);
        }
        
            
        var health = 100;
        var money = 200;
        
        
        var text = new PIXI.Text(health, { font: "50px Arial", fill: "red" });
        text.position.x = 64 * 10;
        stage.addChild(text);
        var textMoney = new PIXI.Text(money, { font: "50px Arial", fill: "red" });
        textMoney.position.x = 64 * 10;
        textMoney.position.y = 64 * 8;
        stage.addChild(textMoney);
        var timer = 0;
        //the animation function
        requestAnimationFrame(animate);
        function animate() {
            for (var i = 0 ; i < uiElements.length; i++) {
                if (uiElements[i].price <= money) {
                    uiElements[i].dimOut();
                } else {
                    uiElements[i].dim();
                }
            }
            timer++;
            timer=timer%1000;
            text.setText("Health: " + health);
            textMoney.setText("Money: " + money);
            for (var i = 0; i < towers.length; i++) {
                towers[i].getTarget(enemies.length-1);
            }
             
                for (var i = 0; i < towers.length; i++) {
                    if(timer%towers[i].shootSpeed==0&&towers[i].target!=null) towers[i].shootTarget();
                }
            
            for(var i=0;i<enemies.length;i++){
                enemies[i].move();                
            }
            renderer.render(stage);
            requestAnimationFrame(animate);
        }
        //end animation
      
    </script>
</body>
</html>
